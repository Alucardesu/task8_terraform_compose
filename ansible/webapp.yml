---
- hosts: _web_server
  become: yes
  vars_files:
    - vars/default.yml

  pre_tasks:
    - name: "Install packages"
      apt: 
        name: "{{ item }}"
        state: present
      loop:
        - nginx
        - php-fpm
        - php-pgsql

  tasks:

   - name: "Sets Nginx conf file"
     template:
       src: "files/nginx.conf.j2"
       dest: "/etc/nginx/sites-available/{{ http_conf }}"

   - name: "Enables new site"
     file:
       src: "/etc/nginx/sites-available/{{ http_conf }}"
       dest: "/etc/nginx/sites-enabled/{{ http_conf }}"
       state: link
     notify: Reload Nginx
  
   - name: "Removes 'default' site"
     file:
       path: "/etc/nginx/sites-enabled/default"
       state: absent
     notify: Reload Nginx

   - name: "Sets Up App"
     template:
       src: "files/webapp.php.j2"
       dest: "/var/www/html/webapp.php"

# Handlers
  handlers:
    - name: Reload Nginx
      service:
        name: nginx
        state: reloaded

    - name: Restart Nginx
      service:
        name: nginx
        state: restarted